name: Add #yasero_dev post URL

on:
  workflow_dispatch:
    inputs:
      post_url:
        description: "X/Twitter post URL (https://x.com/.../status/... or https://twitter.com/.../status/...)"
        required: true
        type: string

permissions:
  actions: write
  contents: read

jobs:
  add-post-url:
    runs-on: ubuntu-latest
    steps:
      - name: Update repository variable
        uses: actions/github-script@v7
        env:
          ACTIONS_VARIABLES_TOKEN: ${{ secrets.ACTIONS_VARIABLES_TOKEN }}
        with:
          github-token: ${{ secrets.ACTIONS_VARIABLES_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const variableName = "YASERO_POST_URLS";
            const inputUrl = `${{ inputs.post_url }}`.trim();
            const tokenSource = process.env.ACTIONS_VARIABLES_TOKEN ? "ACTIONS_VARIABLES_TOKEN" : "GITHUB_TOKEN";

            function failIfPermissionError(error, operation) {
              if (error && error.status === 403) {
                core.setFailed(
                  [
                    `Permission denied while trying to ${operation}.`,
                    "GitHub returned: Resource not accessible by integration.",
                    `Token in use: ${tokenSource}.`,
                    "Fix: set Repository Secret ACTIONS_VARIABLES_TOKEN to a PAT/FGPAT that can read and write repository variables.",
                    "Also verify repository Actions setting allows read and write permissions for workflows."
                  ].join(" ")
                );
                return true;
              }
              return false;
            }

            const urlPattern = /^https:\/\/(?:x|twitter)\.com\/[^/]+\/status\/\d+(?:\?.*)?$/i;
            if (!urlPattern.test(inputUrl)) {
              core.setFailed(`Invalid post URL format: ${inputUrl}`);
              return;
            }

            const normalizedUrl = inputUrl
              .replace(/^https:\/\/twitter\.com\//i, "https://x.com/")
              .split("?")[0];

            let currentValue = "[]";
            try {
              const response = await github.rest.actions.getRepoVariable({
                owner,
                repo,
                name: variableName,
              });
              currentValue = response.data.value || "[]";
            } catch (error) {
              if (failIfPermissionError(error, `read repository variable ${variableName}`)) return;
              if (error.status !== 404) {
                throw error;
              }
            }

            let existing = [];
            try {
              const parsed = JSON.parse(currentValue);
              if (Array.isArray(parsed)) {
                existing = parsed.filter((item) => typeof item === "string");
              }
            } catch (error) {
              core.warning(`Current ${variableName} is not valid JSON. It will be reset.`);
            }

            const deduped = [];
            const seen = new Set();
            for (const item of existing) {
              const value = item.trim();
              if (!value || seen.has(value)) continue;
              seen.add(value);
              deduped.push(value);
            }

            const nextPosts = seen.has(normalizedUrl) ? deduped : [normalizedUrl, ...deduped];
            const nextValue = JSON.stringify(nextPosts);

            if (nextValue === currentValue) {
              core.info("URL already exists. No update needed.");
              return;
            }

            if (currentValue === "[]") {
              try {
                await github.rest.actions.createRepoVariable({
                  owner,
                  repo,
                  name: variableName,
                  value: nextValue,
                });
                core.info(`Created ${variableName} with ${nextPosts.length} URL(s).`);
                return;
              } catch (error) {
                if (failIfPermissionError(error, `create repository variable ${variableName}`)) return;
                if (error.status !== 409) throw error;
              }
            }

            try {
              await github.rest.actions.updateRepoVariable({
                owner,
                repo,
                name: variableName,
                value: nextValue,
              });
            } catch (error) {
              if (failIfPermissionError(error, `update repository variable ${variableName}`)) return;
              throw error;
            }
            core.info(`Updated ${variableName}. Total URLs: ${nextPosts.length}`);
