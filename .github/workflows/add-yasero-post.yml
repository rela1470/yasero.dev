name: Add #yasero_dev post URL

on:
  workflow_dispatch:
    inputs:
      post_url:
        description: "X/Twitter post URL (https://x.com/.../status/... or https://twitter.com/.../status/...)"
        required: true
        type: string

permissions:
  actions: write
  contents: read

jobs:
  add-post-url:
    runs-on: ubuntu-latest
    steps:
      - name: Update repository variable
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const variableName = "YASERO_POST_URLS";
            const inputUrl = `${{ inputs.post_url }}`.trim();

            const urlPattern = /^https:\/\/(?:x|twitter)\.com\/[^/]+\/status\/\d+(?:\?.*)?$/i;
            if (!urlPattern.test(inputUrl)) {
              core.setFailed(`Invalid post URL format: ${inputUrl}`);
              return;
            }

            const normalizedUrl = inputUrl
              .replace(/^https:\/\/twitter\.com\//i, "https://x.com/")
              .split("?")[0];

            let currentValue = "[]";
            try {
              const response = await github.rest.actions.getRepoVariable({
                owner,
                repo,
                name: variableName,
              });
              currentValue = response.data.value || "[]";
            } catch (error) {
              if (error.status !== 404) {
                throw error;
              }
            }

            let existing = [];
            try {
              const parsed = JSON.parse(currentValue);
              if (Array.isArray(parsed)) {
                existing = parsed.filter((item) => typeof item === "string");
              }
            } catch (error) {
              core.warning(`Current ${variableName} is not valid JSON. It will be reset.`);
            }

            const deduped = [];
            const seen = new Set();
            for (const item of existing) {
              const value = item.trim();
              if (!value || seen.has(value)) continue;
              seen.add(value);
              deduped.push(value);
            }

            const nextPosts = seen.has(normalizedUrl) ? deduped : [normalizedUrl, ...deduped];
            const nextValue = JSON.stringify(nextPosts);

            if (nextValue === currentValue) {
              core.info("URL already exists. No update needed.");
              return;
            }

            if (currentValue === "[]") {
              try {
                await github.rest.actions.createRepoVariable({
                  owner,
                  repo,
                  name: variableName,
                  value: nextValue,
                });
                core.info(`Created ${variableName} with ${nextPosts.length} URL(s).`);
                return;
              } catch (error) {
                if (error.status !== 409) throw error;
              }
            }

            await github.rest.actions.updateRepoVariable({
              owner,
              repo,
              name: variableName,
              value: nextValue,
            });
            core.info(`Updated ${variableName}. Total URLs: ${nextPosts.length}`);
